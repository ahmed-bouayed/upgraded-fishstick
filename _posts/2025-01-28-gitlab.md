---
title: gitlab
description: gitlab self-hosted
published: false
date: 2025-01-28
categories: devops
tags: docker git devops
image:
  path: /assets/img/headers/gitlab.webp
  lqip: data:image/webp;base64,UklGRoYAAABXRUJQVlA4IHoAAACwAwCdASoUAAoAPpE4l0eloyIhMAgAsBIJZQAdoABjhlmC5j/rYAD++zm+UmHCvZ3s3yapMFj6BUNMnNKiXaARF5EgVwrljNv8dC5tlMvNID+moegEtjVAZf0/vhqYcPpB+q+QeXlJ5e6blp38Bj8kGmzuYez5wReAAA==
  alt: gitlab
---
## install gitlab

- install docker
- install docker-compose

```shell
mkdir gitlab
cd gitlab
```
```shell
nano docker-compose.yaml
```

```yaml
services:
  gitlab:
    image: gitlab/gitlab-ce:latest
    container_name: gitlab
    restart: always
    hostname: 'gitlab.example.com'
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        # Add any other gitlab.rb configuration here, each on its own line
        external_url 'https://gitlab.example.com'
        gitlab_rails['gitlab_shell_ssh_port'] = 2222
        #Reverse Proxy
        nginx['listen_port'] = 80
        nginx['listen_https'] = false
        nginx['real_ip_trusted_addresses'] = ['<reverse-proxy-ip>']
        nginx['real_ip_header'] = 'X-Forwarded-For'
        nginx['real_ip_recursive'] = 'on'
        # Enable the Container Registry
        registry_external_url 'https://registry.gitlab.example.com'
        gitlab_rails['registry_enabled'] = true
        gitlab_rails['registry_host'] = 'registry.gitlab.example.com'
        gitlab_rails['registry_port'] = '5000'
        gitlab_rails['registry_api_url'] = 'http://registry.gitlab.example.com:5000'
    ports:
      - 80:80
      - 2222:22
      - 5000:5000  # Port for the Container Registry
    volumes:
      - ./gitlab/config:/etc/gitlab
      - ./gitlab/logs:/var/log/gitlab
      - ./gitlab/data:/var/opt/gitlab
    shm_size: '256m'
    restart: unless-stopped
    labels:
      # traefik_gitlab
      - "traefik.enable=true"
      - "traefik.http.routers.gitlab.rule=Host(`gitlab.example.com`)"
      - "traefik.http.routers.gitlab.entrypoints=websecure"
      - "traefik.http.routers.gitlab.tls=true"
      - "traefik.http.services.gitlab.loadbalancer.server.port=80"
      # traefik_registry
      - "traefik.http.routers.registry.rule=Host(`registry.gitlab.example.com`)"
      - "traefik.http.routers.registry.entrypoints=websecure"
      - "traefik.http.routers.registry.tls=true"
      - "traefik.http.services.registry.loadbalancer.server.port=5000"
# network traefik
networks:
  proxy:
    external: true
```
```shell
sudo docker-compose up -d
```
```shell
sudo docker restart gitlab
```

```shell
sudo docker logs -f gitlab
sudo docker exec -it gitlab grep 'Password:'
sudo docker exec -it gitlab /bin/bash
```

```text
/etc/gitlab/gitlab.rb
gitlab-ctl reconfigure
```

## Install GitLab Runner
To install GitLab Runner

Add the official GitLab repository
```shell
curl -L "https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh" | sudo bash
```

Install the latest version of GitLab Runner

```shell
sudo apt install gitlab-runner
```

## Register a runner

Obtain a runner authentication token. You can either
- Create an instance, group, or project runner.
- Locate the runner authentication token in the `config.toml` file. Runner authentication tokens have the prefix, `glrt-`.

GITLAB_RUNNER_DISABLE_SKEL=false

Run the register command
sudo gitlab-runner register

You can use the non-interactive mode to use additional arguments to register the runner
```shell
sudo gitlab-runner register \
  --non-interactive \
  --url "https://gitlab.example.com" \
  --token "$RUNNER_TOKEN" \
  --registration-token "$PROJECT_REGISTRATION_TOKEN" \
  --executor "docker" \
  --docker-image alpine:latest \
  --description "docker-runner" \
  --maintenance-note "Free-form maintainer notes about this runner" \
  --tag-list "docker,aws" \
  --run-untagged="true" \
  --locked="false" \
  --access-level="not_protected"
```
{: .nolineno }
````markdown
--access-level creates a protected runner.
- For a protected runner, use the --access-level="ref_protected" parameter.
- For an unprotected runner, use --access-level="not_protected" or leave the value undefined.

--maintenance-note allows adding information you might find helpful for runner maintenance. The maximum length is 255 characters.
The legacy-compatible registration process ignores the following command-line parameters. These parameters can only be configured when a runner is created in the UI or with the API.
--locked
--access-level
--run-untagged
--maximum-timeout
--paused
--tag-list
--maintenance-note
````

## Backup and Restore
To back up your GitLab data, you can use the following command

sudo docker exec -t gitlab gitlab-rake gitlab:backup:create
To restore from a backup, use:

sudo docker exec -t gitlab gitlab-rake gitlab:backup:restore BACKUP=<backup_file_name>


## Log in to the Container Registry
To push or pull Docker images, log in to the Container Registry

```shell
docker login registry.gitlab.example.com
```

You'll be prompted to enter your GitLab username and password (or a personal access token with the read_registry and write_registry scopes).

## Push Docker Images
Push an Image
Tag and push a Docker image to the registry
```shell
docker build -t registry.gitlab.example.com/my-group/my-project/my-image:latest .
docker push registry.gitlab.example.com/my-group/my-project/my-image:latest
```
## Pull an Image
Pull an image from the registry
```shell
docker pull registry.gitlab.example.com/my-group/my-project/my-image:latest
```